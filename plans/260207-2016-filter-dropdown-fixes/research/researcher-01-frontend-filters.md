# Frontend Filter/Dropdown System Research

**Research Date**: 2026-02-07
**Focus**: Filter dropdowns, route-specific defaults, Sort/Year/Length implementation

---

## 1. Architecture Overview

### Core Files
- **Main filter page**: `apps/web/src/views/filter/Filter.tsx`
- **Filter form**: `apps/web/src/views/filter/components/Filters/Filter.tsx`
- **Dropdown base**: `apps/web/src/views/filter/components/Filters/components/ButtonFilter.tsx`
- **Individual filters**: `Sort.tsx`, `Year.tsx`, `Length.tsx`, `Type.tsx`, `Status.tsx`, `Genre.tsx`, `Language.tsx`

### Route Configuration
**File**: `apps/web/src/configs/routes.config/appsRoute.tsx`

Routes `/newest`, `/updated`, `/added`, `/genre/:slug`, `/filter` all use same component: `Filter.tsx`

---

## 2. Route-Specific Defaults

**File**: `apps/web/src/views/filter/Filter.tsx` (lines 15-25)

```typescript
const ROUTE_CONFIG: Record<
  string,
  { title: string; sortBy: MangaQueryParams['sortBy']; sortOrder: 'asc' | 'desc' }
> = {
  '/newest': { title: 'Newest', sortBy: 'releaseYear', sortOrder: 'desc' },
  '/updated': { title: 'Updated', sortBy: 'updatedAt', sortOrder: 'desc' },
  '/added': { title: 'Recently Added', sortBy: 'createdAt', sortOrder: 'desc' },
  '/filter': { title: 'Filter', sortBy: 'createdAt', sortOrder: 'desc' },
}
```

### Default Resolution Logic (lines 82-86)
```typescript
const isGenreRoute = pathname.startsWith('/genre/')
const routeConfig = isGenreRoute
  ? { title: '', sortBy: 'createdAt' as const, sortOrder: 'desc' as const }
  : ROUTE_CONFIG[pathname] || DEFAULT_ROUTE_CONFIG
```

### API Params Builder (lines 27-62, `buildApiParams()`)
Priority order:
1. URL query param `?sort=...` → sets `sortBy` + `sortOrder: 'desc'`
2. Route defaults from `ROUTE_CONFIG`
3. Fallback to `/filter` defaults

**Issue**: Line 55 hardcodes `sortOrder: 'desc'` when `?sort=` param exists, ignoring route-aware order.

---

## 3. Sort Dropdown Implementation

**File**: `apps/web/src/views/filter/components/Filters/components/Sort.tsx`

### Options (lines 8-18)
```typescript
const data = [
  { id: 'sort-updatedAt', value: 'updatedAt', label: 'Recently updated' },
  { id: 'sort-createdAt', value: 'createdAt', label: 'Recently added' },
  { id: 'sort-releaseYear', value: 'releaseYear', label: 'Release date' },
  { id: 'sort-views-trending', value: 'views', label: 'Trending' },
  { id: 'sort-title', value: 'title', label: 'Name A-Z' },
  { id: 'sort-rating', value: 'rating', label: 'Scores' },
  { id: 'sort-rating-mal', value: 'rating', label: 'MAL scores' },
  { id: 'sort-views', value: 'views', label: 'Most viewed' },
  { id: 'sort-views-fav', value: 'views', label: 'Most favourited' },
]
```

### Configuration
- **Type**: `radio` (single selection, line 32)
- **Enum key**: `EnumFilter.sort` (line 31)
- **Form name**: `sort` (generated by ButtonFilter for radio type)

### Known Issues
- **Duplicate `value`**: `'views'` appears 3x (trending, most viewed, most favourited)
- **Duplicate `value`**: `'rating'` appears 2x (scores, MAL scores)
- **No state management**: Does NOT read URL params to pre-select default
- **Name A-Z order**: `value: 'title'` hardcoded to `sortOrder: 'desc'` (line 55 in Filter.tsx), should be `'asc'`

---

## 4. Year Filter Implementation

**File**: `apps/web/src/views/filter/components/Filters/components/Year.tsx`

### Options (lines 6-152)
Hardcoded array: `2023`, `2022`, ..., `2003`, `2000s`, `1990s`, ..., `1930s`

### Configuration
- **Type**: `checkbox` (multi-select, default via ButtonFilter.tsx line 14)
- **Enum key**: `EnumFilter.year` (line 165)
- **Form name**: `year[]` (generated by ButtonFilter for checkbox type)

### Current Behavior
- **NOT used by API**: `buildApiParams()` reads `year` from URL but does NOT map to `MangaQueryParams`
- **Backend support**: Unknown if API accepts year filtering
- **Form submission**: Line 120-121 collects `year` multi-value, sets URL param `?year=2023,2022`

### Shared Type
**File**: `packages/shared/src/types/manga.ts` (lines 110-119)

`MangaQueryParams` does NOT include `year` or `minChapters` fields.

---

## 5. Length Filter Implementation

**File**: `apps/web/src/views/filter/components/Filters/components/Length.tsx`

### Options (lines 7-43)
```typescript
const data = [
  { id: 'minchap-1', value: '1', label: '>= 1 chapters' },
  { id: 'minchap-3', value: '3', label: '>= 3 chapters' },
  ...
  { id: 'minchap-50', value: '50', label: '>= 50 chapters' },
]
```

### Configuration
- **Type**: `radio` (single selection, line 53)
- **Enum key**: `EnumFilter.length` (line 56)
- **Form name**: `length` (generated by ButtonFilter for radio type)

### Current Behavior
- **NOT used by API**: `buildApiParams()` does NOT process `length` param
- **Backend support**: Unknown
- **Form submission**: Line 122 collects `length`, sets URL param `?length=10`

---

## 6. ButtonFilter Component

**File**: `apps/web/src/views/filter/components/Filters/components/ButtonFilter.tsx`

### Props (lines 7-16)
```typescript
type CommonFilterProps = {
  data: FilterDropdown[]           // { id, value, label, checked? }
  value: EnumFilter                // 'sort', 'year', 'length', etc.
  onToggle: () => void
  open: boolean
  dropdownClassName?: string
  type?: 'checkbox' | 'radio'      // default: 'checkbox'
}
```

### Form Name Generation (line 68)
```typescript
name={type === 'checkbox' ? `${value}[]` : value}
```
- Checkbox → `genre[]`, `year[]`
- Radio → `sort`, `length`

### Key Limitation
**No `defaultValue` or `checked` state management**: Inputs do NOT reflect URL params or route defaults. Dropdowns always render unchecked unless `item.checked` is provided.

---

## 7. Form Submission Flow

**File**: `apps/web/src/views/filter/Filter.tsx` (lines 113-139, `handleSubmit()`)

### Process
1. `FormData` extracts all inputs
2. Build `searchParams` for URL: `?page=1&keyword=...&type=...&genre=...&sort=...`
3. `setSearchParams()` triggers re-render
4. `buildApiParams()` reads new URL → calls API via `useMangaList()`

### URL Params NOT Processed by API
- `year` — collected, set in URL, ignored by `buildApiParams()`
- `length` — collected, set in URL, ignored by `buildApiParams()`
- `language` — collected, set in URL, ignored by `buildApiParams()`

---

## 8. Backend Query Params

**File**: `packages/shared/src/types/manga.ts` (lines 110-119)

```typescript
export interface MangaQueryParams {
  page?: number
  limit?: number
  status?: MangaStatus
  type?: MangaType
  genreId?: number               // singular, FE sends CSV but only first is used (line 47)
  search?: string
  sortBy?: 'rating' | 'views' | 'createdAt' | 'updatedAt' | 'releaseYear' | 'title'
  sortOrder?: 'asc' | 'desc'
}
```

**Missing fields**: `year`, `minChapters`, `language`, multi-genre support

---

## 9. Enum Definitions

### Frontend
**File**: `packages/shared/src/types/filter.ts` (lines 1-9)
```typescript
export enum EnumFilter {
  'type' = 'type',
  'genre' = 'genre',
  'status' = 'status',
  'language' = 'language',
  'year' = 'year',
  'length' = 'length',
  'sort' = 'sort',
}
```

### Backend Enums
**File**: `packages/shared/src/types/manga.ts`
- `MangaStatus`: `ongoing`, `completed`, `hiatus`, `cancelled` (lines 36-41)
- `MangaType`: `manga`, `manhwa`, `manhua`, `one_shot`, `doujinshi` (lines 43-49)

**Mismatch**: Status.tsx (lines 14, 18, 29) uses `'releasing'`, `'on_hiatus'`, `'info'` — NOT in backend enum.

---

## 10. Current Bugs & Missing Features

### Sort Dropdown
1. **Name A-Z always DESC**: `'title'` sort ignores alphabetical order (should be ASC)
2. **No default selection**: Dropdowns don't show pre-selected state matching route defaults
3. **Duplicate values**: `'views'` and `'rating'` used by multiple options

### Year/Length Filters
1. **Non-functional**: URL params collected but NOT sent to API
2. **Backend missing**: `MangaQueryParams` lacks `year`/`minChapters` fields

### Status Filter
1. **Enum mismatch**: FE uses `'releasing'`, backend uses `'ongoing'`

### Route-Aware Sorting
1. **Hardcoded DESC**: Line 55 in `buildApiParams()` forces `sortOrder: 'desc'` when `?sort=` exists
2. **No UI feedback**: User can't see which sort is active on `/newest`, `/updated`, `/added` pages

---

## Unresolved Questions

1. Does backend support `year` filtering? Need to check API implementation.
2. Does backend support `minChapters` (length) filtering?
3. Should multi-genre filtering be OR or AND logic? (Genre.tsx has "Must have all" checkbox but not wired)
4. What's the correct mapping for Status enum mismatch?
5. Should "Name A-Z" also have a "Name Z-A" option, or toggle order dynamically?
